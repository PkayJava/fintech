package com.angkorteam.bank.dao.base.flyway;

import com.angkorteam.bank.dao.base.Checksum;
import com.angkorteam.jdbc.query.InsertQuery;
import com.angkorteam.jdbc.query.SelectQuery;
import com.angkorteam.metamodel.LiquibaseJavaMigration;
import org.apache.metamodel.jdbc.JdbcDataContext;
import org.apache.metamodel.schema.Table;
import org.flywaydb.core.api.migration.Context;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import javax.sql.DataSource;
import java.util.Map;

public class V4__MifosXCoreReportsUTF8 extends LiquibaseJavaMigration {

    @Override
    public Integer getChecksum() {
        return Checksum.V4__MifosXCoreReportsUTF8;
    }

    @Override
    protected void doMigrate(Context context, DataSource dataSource, NamedParameterJdbcTemplate named, JdbcDataContext dataContext) throws Exception {
        {
            dataContext.refreshSchemas();
            Table stretchy_report = dataContext.getDefaultSchema().getTableByName("stretchy_report");
            insert_stretchy_report(named, stretchy_report, 1, "Client Listing", "Table", null, "Client", "select \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\n c.account_no as \"Client Account No.\",  \nc.display_name as \"Name\",  \n\nc.joined_date as \"Joined\", c.external_id as \"External Id\"\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand \n\nounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\nwhere o.id = ${officeId}\nand c.is_deleted=0\n\n\norder by ounder.hierarchy, c.account_no", "Individual Client Report\n\nLists the small number of defined fields on the client table.  Would expect to copy this \n\nreport and add any 'one to one' additional data for specific tenant needs.\n\nCan be run for any size MFI but you'd expect it only to be run within a branch for \n\nlarger ones.  Depending on how many columns are displayed, there is probably is a limit of about 20/50k clients returned for html display (export to excel doesn't \n\nhave that client browser/memory impact).", 1, 1);
            insert_stretchy_report(named, stretchy_report, 2, "Client Loans Listing", "Table", null, "Client", "select \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nc.account_no as \"Client \n\nAccount No.\", \nc.display_name as \"Name\", \nlo.display_name as \"Loan Officer\", l.account_no as \"Loan Account No.\", l.external_id as \"External Id\", \n\n\np.name as Loan, st.enum_message_property as \"Status\",  \nf.`name` as Fund, purp.code_value as \"Loan Purpose\",\nifnull(cur.display_symbol, l.currency_code) as Currency,  \nl.principal_amount,\n\n\nl.arrearstolerance_amount as \"Arrears Tolerance Amount\",\nl.number_of_repayments as \"Expected No. Repayments\",\nl.annual_nominal_interest_rate as \" Annual \n\nNominal Interest Rate\", \nl.nominal_interest_rate_per_period as \"Nominal Interest Rate Per Period\",\n\nipf.enum_message_property as \"Interest Rate Frequency\n\n\",\nim.enum_message_property as \"Interest Method\",\nicp.enum_message_property as \"Interest Calculated in Period\",\nl.term_frequency as \"Term Frequency\",\n\n\ntf.enum_message_property as \"Term Frequency Period\",\nl.repay_every as \"Repayment Frequency\",\nrf.enum_message_property as \"Repayment Frequency Period\",\n\n\nam.enum_message_property as \"Amortization\",\n\nl.total_charges_due_at_disbursement_derived as \"Total Charges Due At Disbursement\",\n\ndate( \n\nl.submittedon_date) as Submitted, date(l.approvedon_date) Approved, l.expected_disbursedon_date As \"Expected Disbursal\",\ndate(l.expected_firstrepaymenton_date) as \n\n\"Expected First Repayment\", date(l.interest_calculated_from_date) as \"Interest Calculated From\" ,\ndate(l.disbursedon_date) as Disbursed, date\n\n(l.expected_maturedon_date) \"Expected Maturity\",\ndate(l.maturedon_date) as \"Matured On\", date(l.closedon_date) as Closed,\ndate(l.rejectedon_date) as \n\nRejected, date(l.rescheduledon_date) as Rescheduled, \ndate(l.withdrawnon_date) as Withdrawn, date(l.writtenoffon_date) \"Written Off\"\nfrom m_office o \njoin \n\nm_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on \n\nc.office_id = ounder.id\nleft join m_loan l on l.client_id = c.id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_product_loan p on p.id = \n\nl.product_id\nleft join m_fund f on f.id = l.fund_id\nleft join r_enum_value st on st.enum_name = \"loan_status_id\" and st.enum_id = l.loan_status_id\nleft join \n\nr_enum_value ipf on ipf.enum_name = \"interest_period_frequency_enum\" and ipf.enum_id = l.interest_period_frequency_enum\nleft join r_enum_value im on im.enum_name \n\n= \"interest_method_enum\" and im.enum_id = l.interest_method_enum\nleft join r_enum_value tf on tf.enum_name = \"term_period_frequency_enum\" and tf.enum_id = \n\nl.term_period_frequency_enum\nleft join r_enum_value icp on icp.enum_name = \"interest_calculated_in_period_enum\" and icp.enum_id = \n\nl.interest_calculated_in_period_enum\nleft join r_enum_value rf on rf.enum_name = \"repayment_period_frequency_enum\" and rf.enum_id = \n\nl.repayment_period_frequency_enum\nleft join r_enum_value am on am.enum_name = \"amortization_method_enum\" and am.enum_id = l.amortization_method_enum\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\n\nleft \n\njoin m_currency cur on cur.code = l.currency_code\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand \n\n(l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \n\n\"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\norder by ounder.hierarchy, 2 , l.id", "Individual Client Report\n\nPretty \n\nwide report that lists the basic details of client loans.  \n\nCan be run for any size MFI but you'd expect it only to be run within a branch for larger ones.  \n\nThere is probably is a limit of about 20/50k clients returned for html display (export to excel doesn't have that client browser/memory impact).", 1, 1);
            insert_stretchy_report(named, stretchy_report, 5, "Loans Awaiting Disbursal", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nc.account_no as \"Client Account No\", c.display_name as \"Name\", l.account_no as \"Loan Account No.\", pl.`name` as \"Product\", \nf.`name` as Fund, ifnull(cur.display_symbol, l.currency_code) as Currency,  \nl.principal_amount as Principal,  \nl.term_frequency as \"Term Frequency\",\n\n\ntf.enum_message_property as \"Term Frequency Period\",\nl.annual_nominal_interest_rate as \" Annual Nominal Interest Rate\",\ndate(l.approvedon_date) \"Approved\",\ndatediff(l.expected_disbursedon_date, curdate()) as \"Days to Disbursal\",\ndate(l.expected_disbursedon_date) \"Expected Disbursal\",\npurp.code_value as \"Loan Purpose\",\n lo.display_name as \"Loan Officer\"\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nleft join r_enum_value tf on tf.enum_name = \"term_period_frequency_enum\" and tf.enum_id = l.term_period_frequency_enum\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 200\norder by ounder.hierarchy, datediff(l.expected_disbursedon_date, curdate()),  c.account_no", "Individual Client Report", 1, 1);
            insert_stretchy_report(named, stretchy_report, 6, "Loans Awaiting Disbursal Summary", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\npl.`name` as \"Product\", \nifnull(cur.display_symbol, l.currency_code) as Currency,  f.`name` as Fund,\nsum(l.principal_amount) as Principal\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 200\ngroup by ounder.hierarchy, pl.`name`, l.currency_code,  f.`name`\norder by ounder.hierarchy, pl.`name`, l.currency_code,  f.`name`", "Individual Client Report", 1, 1);
            insert_stretchy_report(named, stretchy_report, 7, "Loans Awaiting Disbursal Summary by Month", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\npl.`name` as \"Product\", \nifnull(cur.display_symbol, l.currency_code) as Currency,  \nyear(l.expected_disbursedon_date) as \"Year\", \nmonthname(l.expected_disbursedon_date) as \"Month\",\nsum(l.principal_amount) as Principal\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 200\ngroup by ounder.hierarchy, pl.`name`, l.currency_code, year(l.expected_disbursedon_date), month(l.expected_disbursedon_date)\norder by ounder.hierarchy, pl.`name`, l.currency_code, year(l.expected_disbursedon_date), month(l.expected_disbursedon_date)", "Individual Client Report", 1, 1);
            insert_stretchy_report(named, stretchy_report, 8, "Loans Pending Approval", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nc.account_no as \"Client Account No.\", c.display_name as \"Client Name\", \nifnull(cur.display_symbol, l.currency_code) as Currency,  pl.`name` as \"Product\", \nl.account_no as \"Loan Account No.\", \nl.principal_amount as \"Loan Amount\", \nl.term_frequency as \"Term Frequency\",\n\n\ntf.enum_message_property as \"Term Frequency Period\",\nl.annual_nominal_interest_rate as \" Annual \n\nNominal Interest Rate\", \ndatediff(curdate(), l.submittedon_date) \"Days Pending Approval\", \npurp.code_value as \"Loan Purpose\",\nlo.display_name as \"Loan Officer\"\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nleft join r_enum_value tf on tf.enum_name = \"term_period_frequency_enum\" and tf.enum_id = l.term_period_frequency_enum\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 100 /*Submitted and awaiting approval */\norder by ounder.hierarchy, l.submittedon_date,  l.account_no", "Individual Client Report", 1, 1);
            insert_stretchy_report(named, stretchy_report, 11, "Active Loans - Summary", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(mo.`hierarchy`) - LENGTH(REPLACE(mo.`hierarchy`, '.', '')) - 1))), mo.`name`) as \"Office/Branch\", x.currency as Currency,\n x.client_count as \"No. of Clients\", x.active_loan_count as \"No. Active Loans\", x. loans_in_arrears_count as \"No. of Loans in Arrears\",\nx.principal as \"Total Loans Disbursed\", x.principal_repaid as \"Principal Repaid\", x.principal_outstanding as \"Principal Outstanding\", x.principal_overdue as \"Principal Overdue\",\nx.interest as \"Total Interest\", x.interest_repaid as \"Interest Repaid\", x.interest_outstanding as \"Interest Outstanding\", x.interest_overdue as \"Interest Overdue\",\nx.fees as \"Total Fees\", x.fees_repaid as \"Fees Repaid\", x.fees_outstanding as \"Fees Outstanding\", x.fees_overdue as \"Fees Overdue\",\nx.penalties as \"Total Penalties\", x.penalties_repaid as \"Penalties Repaid\", x.penalties_outstanding as \"Penalties Outstanding\", x.penalties_overdue as \"Penalties Overdue\",\n\n\t(case\n\twhen ${parType} = 1 then\n    cast(round((x.principal_overdue * 100) / x.principal_outstanding, 2) as char)\n\twhen ${parType} = 2 then\n    cast(round(((x.principal_overdue + x.interest_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding), 2) as char)\n\twhen ${parType} = 3 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding), 2) as char)\n\twhen ${parType} = 4 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue + x.penalties_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding + x.penalties_overdue), 2) as char)\n\telse \"invalid PAR Type\"\n\tend) as \"Portfolio at Risk %\"\n from m_office mo\njoin \n(select ounder.id as branch,\nifnull(cur.display_symbol, l.currency_code) as currency,\ncount(distinct(c.id)) as client_count, \ncount(distinct(l.id)) as  active_loan_count,\ncount(distinct(if(laa.loan_id is not null,  l.id, null)  )) as loans_in_arrears_count,\n\nsum(l.principal_disbursed_derived) as principal,\nsum(l.principal_repaid_derived) as principal_repaid,\nsum(l.principal_outstanding_derived) as principal_outstanding,\nsum(laa.principal_overdue_derived) as principal_overdue,\n\nsum(l.interest_charged_derived) as interest,\nsum(l.interest_repaid_derived) as interest_repaid,\nsum(l.interest_outstanding_derived) as interest_outstanding,\nsum(laa.interest_overdue_derived) as interest_overdue,\n\nsum(l.fee_charges_charged_derived) as fees,\nsum(l.fee_charges_repaid_derived) as fees_repaid,\nsum(l.fee_charges_outstanding_derived)  as fees_outstanding,\nsum(laa.fee_charges_overdue_derived) as fees_overdue,\n\nsum(l.penalty_charges_charged_derived) as penalties,\nsum(l.penalty_charges_repaid_derived) as penalties_repaid,\nsum(l.penalty_charges_outstanding_derived) as penalties_outstanding,\nsum(laa.penalty_charges_overdue_derived) as penalties_overdue\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nleft join m_currency cur on cur.code = l.currency_code\n\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\ngroup by ounder.id, l.currency_code) x on x.branch = mo.id\norder by mo.hierarchy, x.Currency", null, 1, 1);
            insert_stretchy_report(named, stretchy_report, 12, "Active Loans - Details", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, l.currency_code) as Currency,\nlo.display_name as \"Loan Officer\", \nc.display_name as \"Client\", l.account_no as \"Loan Account No.\", pl.`name` as \"Product\", \nf.`name` as Fund,  \nl.principal_amount as \"Loan Amount\", \nl.annual_nominal_interest_rate as \" Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed Date\", \ndate(l.expected_maturedon_date) as \"Expected Matured On\",\n\nl.principal_repaid_derived as \"Principal Repaid\",\nl.principal_outstanding_derived as \"Principal Outstanding\",\nlaa.principal_overdue_derived as \"Principal Overdue\",\n\nl.interest_repaid_derived as \"Interest Repaid\",\nl.interest_outstanding_derived as \"Interest Outstanding\",\nlaa.interest_overdue_derived as \"Interest Overdue\",\n\nl.fee_charges_repaid_derived as \"Fees Repaid\",\nl.fee_charges_outstanding_derived  as \"Fees Outstanding\",\nlaa.fee_charges_overdue_derived as \"Fees Overdue\",\n\nl.penalty_charges_repaid_derived as \"Penalties Repaid\",\nl.penalty_charges_outstanding_derived as \"Penalties Outstanding\",\npenalty_charges_overdue_derived as \"Penalties Overdue\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\ngroup by l.id\norder by ounder.hierarchy, l.currency_code, c.account_no, l.account_no", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 13, "Obligation Met Loans Details", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, l.currency_code) as Currency,\nc.account_no as \"Client Account No.\", c.display_name as \"Client\",\nl.account_no as \"Loan Account No.\", pl.`name` as \"Product\", \nf.`name` as Fund,  \nl.principal_amount as \"Loan Amount\", \nl.total_repayment_derived  as \"Total Repaid\", \nl.annual_nominal_interest_rate as \" Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed\", \ndate(l.closedon_date) as \"Closed\",\n\nl.principal_repaid_derived as \"Principal Repaid\",\nl.interest_repaid_derived as \"Interest Repaid\",\nl.fee_charges_repaid_derived as \"Fees Repaid\",\nl.penalty_charges_repaid_derived as \"Penalties Repaid\",\nlo.display_name as \"Loan Officer\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand (case\n\twhen ${obligDateType} = 1 then\n    l.closedon_date between '${startDate}' and '${endDate}'\n\twhen ${obligDateType} = 2 then\n    l.disbursedon_date between '${startDate}' and '${endDate}'\n\telse 1 = 1\n\tend)\nand l.loan_status_id = 600\ngroup by l.id\norder by ounder.hierarchy, l.currency_code, c.account_no, l.account_no", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 14, "Obligation Met Loans Summary", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, l.currency_code) as Currency,\ncount(distinct(c.id)) as \"No. of Clients\",\ncount(distinct(l.id)) as \"No. of Loans\",\nsum(l.principal_amount) as \"Total Loan Amount\", \nsum(l.principal_repaid_derived) as \"Total Principal Repaid\",\nsum(l.interest_repaid_derived) as \"Total Interest Repaid\",\nsum(l.fee_charges_repaid_derived) as \"Total Fees Repaid\",\nsum(l.penalty_charges_repaid_derived) as \"Total Penalties Repaid\",\nsum(l.interest_waived_derived) as \"Total Interest Waived\",\nsum(l.fee_charges_waived_derived) as \"Total Fees Waived\",\nsum(l.penalty_charges_waived_derived) as \"Total Penalties Waived\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand (case\n\twhen ${obligDateType} = 1 then\n    l.closedon_date between '${startDate}' and '${endDate}'\n\twhen ${obligDateType} = 2 then\n    l.disbursedon_date between '${startDate}' and '${endDate}'\n\telse 1 = 1\n\tend)\nand l.loan_status_id = 600\ngroup by ounder.hierarchy, l.currency_code\norder by ounder.hierarchy, l.currency_code", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 15, "Portfolio at Risk", "Table", null, "Loan", "select x.Currency, x.`Principal Outstanding`, x.`Principal Overdue`, x.`Interest Outstanding`, x.`Interest Overdue`, \nx.`Fees Outstanding`, x.`Fees Overdue`, x.`Penalties Outstanding`, x.`Penalties Overdue`,\n\n\t(case\n\twhen ${parType} = 1 then\n    cast(round((x.`Principal Overdue` * 100) / x.`Principal Outstanding`, 2) as char)\n\twhen ${parType} = 2 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding`), 2) as char)\n\twhen ${parType} = 3 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue` + x.`Fees Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding` + x.`Fees Outstanding`), 2) as char)\n\twhen ${parType} = 4 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue` + x.`Fees Overdue` + x.`Penalties Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding` + x.`Fees Outstanding` + x.`Penalties Overdue`), 2) as char)\n\telse \"invalid PAR Type\"\n\tend) as \"Portfolio at Risk %\"\n from \n(select  ifnull(cur.display_symbol, l.currency_code) as Currency,  \nsum(l.principal_outstanding_derived) as \"Principal Outstanding\",\nsum(laa.principal_overdue_derived) as \"Principal Overdue\",\n\nsum(l.interest_outstanding_derived) as \"Interest Outstanding\",\nsum(laa.interest_overdue_derived) as \"Interest Overdue\",\n\nsum(l.fee_charges_outstanding_derived)  as \"Fees Outstanding\",\nsum(laa.fee_charges_overdue_derived) as \"Fees Overdue\",\n\nsum(penalty_charges_outstanding_derived) as \"Penalties Outstanding\",\nsum(laa.penalty_charges_overdue_derived) as \"Penalties Overdue\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin  m_loan l on l.client_id = c.id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nleft join m_product_loan p on p.id = l.product_id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\ngroup by l.currency_code\norder by l.currency_code) x", "Covers all loans.\n\nFor larger MFIs … we should add some derived fields on loan (or a 1:1 loan related table like mifos 2.x does)\nPrinciple, Interest, Fees, Penalties Outstanding and Overdue (possibly waived and written off too)", 1, 1);
            insert_stretchy_report(named, stretchy_report, 16, "Portfolio at Risk by Branch", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(mo.`hierarchy`) - LENGTH(REPLACE(mo.`hierarchy`, '.', '')) - 1))), mo.`name`) as \"Office/Branch\",\nx.Currency, x.`Principal Outstanding`, x.`Principal Overdue`, x.`Interest Outstanding`, x.`Interest Overdue`, \nx.`Fees Outstanding`, x.`Fees Overdue`, x.`Penalties Outstanding`, x.`Penalties Overdue`,\n\n\t(case\n\twhen ${parType} = 1 then\n    cast(round((x.`Principal Overdue` * 100) / x.`Principal Outstanding`, 2) as char)\n\twhen ${parType} = 2 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding`), 2) as char)\n\twhen ${parType} = 3 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue` + x.`Fees Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding` + x.`Fees Outstanding`), 2) as char)\n\twhen ${parType} = 4 then\n    cast(round(((x.`Principal Overdue` + x.`Interest Overdue` + x.`Fees Overdue` + x.`Penalties Overdue`) * 100) / (x.`Principal Outstanding` + x.`Interest Outstanding` + x.`Fees Outstanding` + x.`Penalties Overdue`), 2) as char)\n\telse \"invalid PAR Type\"\n\tend) as \"Portfolio at Risk %\"\n from m_office mo\njoin \n(select  ounder.id as \"branch\", ifnull(cur.display_symbol, l.currency_code) as Currency,  \n\nsum(l.principal_outstanding_derived) as \"Principal Outstanding\",\nsum(laa.principal_overdue_derived) as \"Principal Overdue\",\n\nsum(l.interest_outstanding_derived) as \"Interest Outstanding\",\nsum(laa.interest_overdue_derived) as \"Interest Overdue\",\n\nsum(l.fee_charges_outstanding_derived)  as \"Fees Outstanding\",\nsum(laa.fee_charges_overdue_derived) as \"Fees Overdue\",\n\nsum(penalty_charges_outstanding_derived) as \"Penalties Outstanding\",\nsum(laa.penalty_charges_overdue_derived) as \"Penalties Overdue\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin  m_loan l on l.client_id = c.id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_code_value purp on purp.id = l.loanpurpose_cv_id\nleft join m_product_loan p on p.id = l.product_id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\ngroup by ounder.id, l.currency_code) x on x.branch = mo.id\norder by mo.hierarchy, x.Currency", "Covers all loans.\n\nFor larger MFIs … we should add some derived fields on loan (or a 1:1 loan related table like mifos 2.x does)\nPrinciple, Interest, Fees, Penalties Outstanding and Overdue (possibly waived and written off too)", 1, 1);
            insert_stretchy_report(named, stretchy_report, 20, "Funds Disbursed Between Dates Summary", "Table", null, "Fund", "select ifnull(f.`name`, '-') as Fund,  ifnull(cur.display_symbol, l.currency_code) as Currency, \nround(sum(l.principal_amount), 4) as disbursed_amount\nfrom m_office ounder \njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_currency cur on cur.`code` = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nwhere disbursedon_date between '${startDate}' and '${endDate}'\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (l.currency_code = '${currencyId}' or '-1' = '${currencyId}')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\ngroup by ifnull(f.`name`, '-') , ifnull(cur.display_symbol, l.currency_code)\norder by ifnull(f.`name`, '-') , ifnull(cur.display_symbol, l.currency_code)", null, 1, 1);
            insert_stretchy_report(named, stretchy_report, 21, "Funds Disbursed Between Dates Summary by Office", "Table", null, "Fund", "select \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\n \n\nifnull(f.`name`, '-') as Fund,  ifnull(cur.display_symbol, l.currency_code) as Currency, round(sum(l.principal_amount), 4) as disbursed_amount\nfrom m_office o\n\n\njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c \n\non c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_currency cur on cur.`code` = l.currency_code\nleft join m_fund f on f.id = l.fund_id\n\n\nwhere disbursedon_date between '${startDate}' and '${endDate}'\nand o.id = ${officeId}\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand \n\n(l.currency_code = '${currencyId}' or '-1' = '${currencyId}')\ngroup by ounder.`name`,  ifnull(f.`name`, '-') , ifnull(cur.display_symbol, \n\nl.currency_code)\norder by ounder.`name`,  ifnull(f.`name`, '-') , ifnull(cur.display_symbol, l.currency_code)", null, 1, 1);
            insert_stretchy_report(named, stretchy_report, 48, "Balance Sheet", "Pentaho", null, "Accounting", null, "Balance Sheet", 1, 1);
            insert_stretchy_report(named, stretchy_report, 49, "Income Statement", "Pentaho", null, "Accounting", null, "Profit and Loss Statement", 1, 1);
            insert_stretchy_report(named, stretchy_report, 50, "Trial Balance", "Pentaho", null, "Accounting", null, "Trial Balance Report", 1, 1);
            insert_stretchy_report(named, stretchy_report, 51, "Written-Off Loans", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, ml.currency_code) as Currency,  \nc.account_no as \"Client Account No.\",\nc.display_name AS 'Client Name',\nml.account_no AS 'Loan Account No.',\nmpl.name AS 'Product Name',\nml.disbursedon_date AS 'Disbursed Date',\nlt.transaction_date AS 'Written Off date',\nml.principal_amount as \"Loan Amount\",\nifnull(lt.principal_portion_derived, 0) AS 'Written-Off Principal',\nifnull(lt.interest_portion_derived, 0) AS 'Written-Off Interest',\nifnull(lt.fee_charges_portion_derived,0) AS 'Written-Off Fees',\nifnull(lt.penalty_charges_portion_derived,0) AS 'Written-Off Penalties',\nn.note AS 'Reason For Write-Off',\nIFNULL(ms.display_name,'-') AS 'Loan Officer Name'\nFROM m_office o\nJOIN m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%')\nAND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\nJOIN m_client c ON c.office_id = ounder.id\nJOIN m_loan ml ON ml.client_id = c.id\nJOIN m_product_loan mpl ON mpl.id=ml.product_id\nLEFT JOIN m_staff ms ON ms.id=ml.loan_officer_id\nJOIN m_loan_transaction lt ON lt.loan_id = ml.id\nLEFT JOIN m_note n ON n.loan_transaction_id = lt.id\nLEFT JOIN m_currency cur on cur.code = ml.currency_code\nWHERE lt.transaction_type_enum = 6 /*write-off */\nAND lt.is_reversed is false \nAND ml.loan_status_id=601\nAND o.id=${officeId}\nAND (mpl.id=${loanProductId} OR ${loanProductId}=-1)\nAND lt.transaction_date BETWEEN '${startDate}' AND '${endDate}'\nAND (ml.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\") \nORDER BY ounder.hierarchy, ifnull(cur.display_symbol, ml.currency_code), ml.account_no", "Individual Lending Report. Written Off Loans", 1, 1);
            insert_stretchy_report(named, stretchy_report, 52, "Aging Detail", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, ml.currency_code) as Currency,  \nmc.account_no as \"Client Account No.\",\n \tmc.display_name AS \"Client Name\",\n \tml.account_no AS \"Account Number\",\n \tml.principal_amount AS \"Loan Amount\",\n ml.principal_disbursed_derived AS \"Original Principal\",\n ml.interest_charged_derived AS \"Original Interest\",\n ml.principal_repaid_derived AS \"Principal Paid\",\n ml.interest_repaid_derived AS \"Interest Paid\",\n laa.principal_overdue_derived AS \"Principal Overdue\",\n laa.interest_overdue_derived AS \"Interest Overdue\",\nDATEDIFF(CURDATE(), laa.overdue_since_date_derived) as \"Days in Arrears\",\n\n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<7, '<1', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<8, ' 1', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<15,  '2', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<22, ' 3', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<29, ' 4', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<36, ' 5', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<43, ' 6', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<50, ' 7', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<57, ' 8', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<64, ' 9', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<71, '10', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<78, '11', \n \tIF(DATEDIFF(CURDATE(), laa.overdue_since_date_derived)<85, '12', '12+')))))))))))) )AS \"Weeks In Arrears Band\",\n\n\t\tIF(DATEDIFF(CURDATE(),  laa.overdue_since_date_derived)<31, '0 - 30', \n\t\tIF(DATEDIFF(CURDATE(),  laa.overdue_since_date_derived)<61, '30 - 60', \n\t\tIF(DATEDIFF(CURDATE(),  laa.overdue_since_date_derived)<91, '60 - 90', \n\t\tIF(DATEDIFF(CURDATE(),  laa.overdue_since_date_derived)<181, '90 - 180', \n\t\tIF(DATEDIFF(CURDATE(),  laa.overdue_since_date_derived)<361, '180 - 360', \n\t\t\t\t '> 360'))))) AS \"Days in Arrears Band\"\n\n\tFROM m_office mo \n    JOIN m_office ounder ON ounder.hierarchy like concat(mo.hierarchy, '%')\n\t        AND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n    INNER JOIN m_client mc ON mc.office_id=ounder.id\n\t    INNER JOIN m_loan ml ON ml.client_id = mc.id\n\t    INNER JOIN r_enum_value rev ON rev.enum_id=ml.loan_status_id\n    INNER JOIN m_loan_arrears_aging laa ON laa.loan_id=ml.id\n    left join m_currency cur on cur.code = ml.currency_code\n\tWHERE ml.loan_status_id=300\n    AND mo.id=${officeId}\nORDER BY ounder.hierarchy, ifnull(cur.display_symbol, ml.currency_code), ml.account_no", "Loan arrears aging (Weeks)", 1, 1);
            insert_stretchy_report(named, stretchy_report, 53, "Aging Summary (Arrears in Weeks)", "Table", null, "Loan", "SELECT \n  IFNULL(periods.currencyName, periods.currency) as currency, \n  periods.period_no 'Weeks In Arrears (Up To)', \n  IFNULL(ars.loanId, 0) 'No Of Loans', \n  IFNULL(ars.principal,0.0) 'Original Principal', \n  IFNULL(ars.interest,0.0) 'Original Interest', \n  IFNULL(ars.prinPaid,0.0) 'Principal Paid', \n  IFNULL(ars.intPaid,0.0) 'Interest Paid', \n  IFNULL(ars.prinOverdue,0.0) 'Principal Overdue', \n  IFNULL(ars.intOverdue,0.0)'Interest Overdue'\nFROM \n\t/* full table of aging periods/currencies used combo to ensure each line represented */\n  (SELECT curs.code as currency, curs.name as currencyName, pers.* from\n\t(SELECT 'On Schedule' period_no,1 pid UNION\n\t\tSELECT '1',2 UNION\n\t\tSELECT '2',3 UNION\n\t\tSELECT '3',4 UNION\n\t\tSELECT '4',5 UNION\n\t\tSELECT '5',6 UNION\n\t\tSELECT '6',7 UNION\n\t\tSELECT '7',8 UNION\n\t\tSELECT '8',9 UNION\n\t\tSELECT '9',10 UNION\n\t\tSELECT '10',11 UNION\n\t\tSELECT '11',12 UNION\n\t\tSELECT '12',13 UNION\n\t\tSELECT '12+',14) pers,\n\t(SELECT distinctrow moc.code, moc.name\n  \tFROM m_office mo2\n   \tINNER JOIN m_office ounder2 ON ounder2.hierarchy \n\t\t\t\tLIKE CONCAT(mo2.hierarchy, '%')\nAND ounder2.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n   \tINNER JOIN m_client mc2 ON mc2.office_id=ounder2.id\n   \tINNER JOIN m_loan ml2 ON ml2.client_id = mc2.id\n\tINNER JOIN m_organisation_currency moc ON moc.code = ml2.currency_code\n\tWHERE ml2.loan_status_id=300 /* active */\n\tAND mo2.id=${officeId}\nAND (ml2.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")) curs) periods\n\n\nLEFT JOIN /* table of aging periods per currency with gaps if no applicable loans */\n(SELECT \n  \tz.currency, z.arrPeriod, \n\tCOUNT(z.loanId) as loanId, SUM(z.principal) as principal, SUM(z.interest) as interest, \n\tSUM(z.prinPaid) as prinPaid, SUM(z.intPaid) as intPaid, \n\tSUM(z.prinOverdue) as prinOverdue, SUM(z.intOverdue) as intOverdue\nFROM\n\t/*derived table just used to get arrPeriod value (was much slower to\n\tduplicate calc of minOverdueDate in inner query)\nmight not be now with derived fields but didn’t check */\n\t(SELECT x.loanId, x.currency, x.principal, x.interest, x.prinPaid, x.intPaid, x.prinOverdue, x.intOverdue,\n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<1, 'On Schedule', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<8, '1', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<15, '2', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<22, '3', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<29, '4', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<36, '5', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<43, '6', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<50, '7', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<57, '8', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<64, '9', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<71, '10', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<78, '11', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<85, '12',\n\t\t\t\t '12+'))))))))))))) AS arrPeriod\n\n\tFROM /* get the individual loan details */\n\t\t(SELECT ml.id AS loanId, ml.currency_code as currency,\n   \t\t\tml.principal_disbursed_derived as principal, \n\t\t\t   ml.interest_charged_derived as interest, \n   \t\t\tml.principal_repaid_derived as prinPaid, \n\t\t\t   ml.interest_repaid_derived intPaid,\n\n\t\t\t   laa.principal_overdue_derived as prinOverdue,\n\t\t\t   laa.interest_overdue_derived as intOverdue,\n\n\t\t\t   IFNULL(laa.overdue_since_date_derived, curdate()) as minOverdueDate\n\t\t\t  \n  \t\tFROM m_office mo\n   \t\tINNER JOIN m_office ounder ON ounder.hierarchy \n\t\t\t\tLIKE CONCAT(mo.hierarchy, '%')\nAND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n   \t\tINNER JOIN m_client mc ON mc.office_id=ounder.id\n   \t\tINNER JOIN m_loan ml ON ml.client_id = mc.id\n\t\t   LEFT JOIN m_loan_arrears_aging laa on laa.loan_id = ml.id\n\t\tWHERE ml.loan_status_id=300 /* active */\n     \t\tAND mo.id=${officeId}\n     AND (ml.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\n  \t\tGROUP BY ml.id) x\n\t) z \nGROUP BY z.currency, z.arrPeriod ) ars ON ars.arrPeriod=periods.period_no and ars.currency = periods.currency\nORDER BY periods.currency, periods.pid", "Loan amount in arrears by branch", 1, 1);
            insert_stretchy_report(named, stretchy_report, 54, "Rescheduled Loans", "Table", null, "Loan", "SELECT \nconcat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, ml.currency_code) as Currency,  \nc.account_no as \"Client Account No.\",\nc.display_name AS 'Client Name',\nml.account_no AS 'Loan Account No.',\nmpl.name AS 'Product Name',\nml.disbursedon_date AS 'Disbursed Date',\nlt.transaction_date AS 'Written Off date',\nml.principal_amount as \"Loan Amount\",\nifnull(lt.principal_portion_derived, 0) AS 'Rescheduled Principal',\nifnull(lt.interest_portion_derived, 0) AS 'Rescheduled Interest',\nifnull(lt.fee_charges_portion_derived,0) AS 'Rescheduled Fees',\nifnull(lt.penalty_charges_portion_derived,0) AS 'Rescheduled Penalties',\nn.note AS 'Reason For Rescheduling',\nIFNULL(ms.display_name,'-') AS 'Loan Officer Name'\nFROM m_office o\nJOIN m_office ounder ON ounder.hierarchy like concat(o.hierarchy, '%')\nAND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\nJOIN m_client c ON c.office_id = ounder.id\nJOIN m_loan ml ON ml.client_id = c.id\nJOIN m_product_loan mpl ON mpl.id=ml.product_id\nLEFT JOIN m_staff ms ON ms.id=ml.loan_officer_id\nJOIN m_loan_transaction lt ON lt.loan_id = ml.id\nLEFT JOIN m_note n ON n.loan_transaction_id = lt.id\nLEFT JOIN m_currency cur on cur.code = ml.currency_code\nWHERE lt.transaction_type_enum = 7 /*marked for rescheduling */\nAND lt.is_reversed is false \nAND ml.loan_status_id=602\nAND o.id=${officeId}\nAND (mpl.id=${loanProductId} OR ${loanProductId}=-1)\nAND lt.transaction_date BETWEEN '${startDate}' AND '${endDate}'\nAND (ml.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nORDER BY ounder.hierarchy, ifnull(cur.display_symbol, ml.currency_code), ml.account_no", "Individual Lending Report. Rescheduled Loans.  The ability to reschedule (or mark that you have rescheduled the loan elsewhere) is a legacy of the older Mifos product.  Needed for migration.", 1, 1);
            insert_stretchy_report(named, stretchy_report, 55, "Active Loans Passed Final Maturity", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, l.currency_code) as Currency,\nlo.display_name as \"Loan Officer\", \nc.display_name as \"Client\", l.account_no as \"Loan Account No.\", pl.`name` as \"Product\", \nf.`name` as Fund,  \nl.principal_amount as \"Loan Amount\", \nl.annual_nominal_interest_rate as \" Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed Date\", \ndate(l.expected_maturedon_date) as \"Expected Matured On\",\n\nl.principal_repaid_derived as \"Principal Repaid\",\nl.principal_outstanding_derived as \"Principal Outstanding\",\nlaa.principal_overdue_derived as \"Principal Overdue\",\n\nl.interest_repaid_derived as \"Interest Repaid\",\nl.interest_outstanding_derived as \"Interest Outstanding\",\nlaa.interest_overdue_derived as \"Interest Overdue\",\n\nl.fee_charges_repaid_derived as \"Fees Repaid\",\nl.fee_charges_outstanding_derived  as \"Fees Outstanding\",\nlaa.fee_charges_overdue_derived as \"Fees Overdue\",\n\nl.penalty_charges_repaid_derived as \"Penalties Repaid\",\nl.penalty_charges_outstanding_derived as \"Penalties Outstanding\",\nlaa.penalty_charges_overdue_derived as \"Penalties Overdue\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\nand l.expected_maturedon_date < curdate()\ngroup by l.id\norder by ounder.hierarchy, l.currency_code, c.account_no, l.account_no", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 56, "Active Loans Passed Final Maturity Summary", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(mo.`hierarchy`) - LENGTH(REPLACE(mo.`hierarchy`, '.', '')) - 1))), mo.`name`) as \"Office/Branch\", x.currency as Currency,\n x.client_count as \"No. of Clients\", x.active_loan_count as \"No. Active Loans\", x. arrears_loan_count as \"No. of Loans in Arrears\",\nx.principal as \"Total Loans Disbursed\", x.principal_repaid as \"Principal Repaid\", x.principal_outstanding as \"Principal Outstanding\", x.principal_overdue as \"Principal Overdue\",\nx.interest as \"Total Interest\", x.interest_repaid as \"Interest Repaid\", x.interest_outstanding as \"Interest Outstanding\", x.interest_overdue as \"Interest Overdue\",\nx.fees as \"Total Fees\", x.fees_repaid as \"Fees Repaid\", x.fees_outstanding as \"Fees Outstanding\", x.fees_overdue as \"Fees Overdue\",\nx.penalties as \"Total Penalties\", x.penalties_repaid as \"Penalties Repaid\", x.penalties_outstanding as \"Penalties Outstanding\", x.penalties_overdue as \"Penalties Overdue\",\n\n\t(case\n\twhen ${parType} = 1 then\n    cast(round((x.principal_overdue * 100) / x.principal_outstanding, 2) as char)\n\twhen ${parType} = 2 then\n    cast(round(((x.principal_overdue + x.interest_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding), 2) as char)\n\twhen ${parType} = 3 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding), 2) as char)\n\twhen ${parType} = 4 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue + x.penalties_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding + x.penalties_overdue), 2) as char)\n\telse \"invalid PAR Type\"\n\tend) as \"Portfolio at Risk %\"\n from m_office mo\njoin \n(select ounder.id as branch,\nifnull(cur.display_symbol, l.currency_code) as currency,\ncount(distinct(c.id)) as client_count, \ncount(distinct(l.id)) as  active_loan_count,\ncount(distinct(laa.loan_id)  ) as arrears_loan_count,\n\nsum(l.principal_disbursed_derived) as principal,\nsum(l.principal_repaid_derived) as principal_repaid,\nsum(l.principal_outstanding_derived) as principal_outstanding,\nsum(ifnull(laa.principal_overdue_derived,0)) as principal_overdue,\n\nsum(l.interest_charged_derived) as interest,\nsum(l.interest_repaid_derived) as interest_repaid,\nsum(l.interest_outstanding_derived) as interest_outstanding,\nsum(ifnull(laa.interest_overdue_derived,0)) as interest_overdue,\n\nsum(l.fee_charges_charged_derived) as fees,\nsum(l.fee_charges_repaid_derived) as fees_repaid,\nsum(l.fee_charges_outstanding_derived)  as fees_outstanding,\nsum(ifnull(laa.fee_charges_overdue_derived,0)) as fees_overdue,\n\nsum(l.penalty_charges_charged_derived) as penalties,\nsum(l.penalty_charges_repaid_derived) as penalties_repaid,\nsum(l.penalty_charges_outstanding_derived) as penalties_outstanding,\nsum(ifnull(laa.penalty_charges_overdue_derived,0)) as penalties_overdue\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\n\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\nand l.expected_maturedon_date < curdate()\ngroup by ounder.id, l.currency_code) x on x.branch = mo.id\norder by mo.hierarchy, x.Currency", null, 1, 1);
            insert_stretchy_report(named, stretchy_report, 57, "Active Loans in last installment", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(lastInstallment.`hierarchy`) - LENGTH(REPLACE(lastInstallment.`hierarchy`, '.', '')) - 1))), lastInstallment.branch) as \"Office/Branch\",\nlastInstallment.Currency,\nlastInstallment.`Loan Officer`, \nlastInstallment.`Client Account No`, lastInstallment.`Client`, \nlastInstallment.`Loan Account No`, lastInstallment.`Product`, \nlastInstallment.`Fund`,  lastInstallment.`Loan Amount`, \nlastInstallment.`Annual Nominal Interest Rate`, \nlastInstallment.`Disbursed`, lastInstallment.`Expected Matured On` ,\n\nl.principal_repaid_derived as \"Principal Repaid\",\nl.principal_outstanding_derived as \"Principal Outstanding\",\nlaa.principal_overdue_derived as \"Principal Overdue\",\n\nl.interest_repaid_derived as \"Interest Repaid\",\nl.interest_outstanding_derived as \"Interest Outstanding\",\nlaa.interest_overdue_derived as \"Interest Overdue\",\n\nl.fee_charges_repaid_derived as \"Fees Repaid\",\nl.fee_charges_outstanding_derived  as \"Fees Outstanding\",\nlaa.fee_charges_overdue_derived as \"Fees Overdue\",\n\nl.penalty_charges_repaid_derived as \"Penalties Repaid\",\nl.penalty_charges_outstanding_derived as \"Penalties Outstanding\",\nlaa.penalty_charges_overdue_derived as \"Penalties Overdue\"\n\nfrom \n(select l.id as loanId, l.number_of_repayments, min(r.installment), \nounder.id, ounder.hierarchy, ounder.`name` as branch, \nifnull(cur.display_symbol, l.currency_code) as Currency,\nlo.display_name as \"Loan Officer\", c.account_no as \"Client Account No\",\nc.display_name as \"Client\", l.account_no as \"Loan Account No\", pl.`name` as \"Product\", \nf.`name` as Fund,  l.principal_amount as \"Loan Amount\", \nl.annual_nominal_interest_rate as \"Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed\", date(l.expected_maturedon_date) as \"Expected Matured On\"\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_loan_repayment_schedule r on r.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\nand r.completed_derived is false\nand r.duedate >= curdate()\ngroup by l.id\nhaving l.number_of_repayments = min(r.installment)) lastInstallment\njoin m_loan l on l.id = lastInstallment.loanId\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\norder by lastInstallment.hierarchy, lastInstallment.Currency, lastInstallment.`Client Account No`, lastInstallment.`Loan Account No`", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 58, "Active Loans in last installment Summary", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(mo.`hierarchy`) - LENGTH(REPLACE(mo.`hierarchy`, '.', '')) - 1))), mo.`name`) as \"Office/Branch\", x.currency as Currency,\n x.client_count as \"No. of Clients\", x.active_loan_count as \"No. Active Loans\", x. arrears_loan_count as \"No. of Loans in Arrears\",\nx.principal as \"Total Loans Disbursed\", x.principal_repaid as \"Principal Repaid\", x.principal_outstanding as \"Principal Outstanding\", x.principal_overdue as \"Principal Overdue\",\nx.interest as \"Total Interest\", x.interest_repaid as \"Interest Repaid\", x.interest_outstanding as \"Interest Outstanding\", x.interest_overdue as \"Interest Overdue\",\nx.fees as \"Total Fees\", x.fees_repaid as \"Fees Repaid\", x.fees_outstanding as \"Fees Outstanding\", x.fees_overdue as \"Fees Overdue\",\nx.penalties as \"Total Penalties\", x.penalties_repaid as \"Penalties Repaid\", x.penalties_outstanding as \"Penalties Outstanding\", x.penalties_overdue as \"Penalties Overdue\",\n\n\t(case\n\twhen ${parType} = 1 then\n    cast(round((x.principal_overdue * 100) / x.principal_outstanding, 2) as char)\n\twhen ${parType} = 2 then\n    cast(round(((x.principal_overdue + x.interest_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding), 2) as char)\n\twhen ${parType} = 3 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding), 2) as char)\n\twhen ${parType} = 4 then\n    cast(round(((x.principal_overdue + x.interest_overdue + x.fees_overdue + x.penalties_overdue) * 100) / (x.principal_outstanding + x.interest_outstanding + x.fees_outstanding + x.penalties_overdue), 2) as char)\n\telse \"invalid PAR Type\"\n\tend) as \"Portfolio at Risk %\"\n from m_office mo\njoin \n(select lastInstallment.branchId as branchId,\nlastInstallment.Currency,\ncount(distinct(lastInstallment.clientId)) as client_count, \ncount(distinct(lastInstallment.loanId)) as  active_loan_count,\ncount(distinct(laa.loan_id)  ) as arrears_loan_count,\n\nsum(l.principal_disbursed_derived) as principal,\nsum(l.principal_repaid_derived) as principal_repaid,\nsum(l.principal_outstanding_derived) as principal_outstanding,\nsum(ifnull(laa.principal_overdue_derived,0)) as principal_overdue,\n\nsum(l.interest_charged_derived) as interest,\nsum(l.interest_repaid_derived) as interest_repaid,\nsum(l.interest_outstanding_derived) as interest_outstanding,\nsum(ifnull(laa.interest_overdue_derived,0)) as interest_overdue,\n\nsum(l.fee_charges_charged_derived) as fees,\nsum(l.fee_charges_repaid_derived) as fees_repaid,\nsum(l.fee_charges_outstanding_derived)  as fees_outstanding,\nsum(ifnull(laa.fee_charges_overdue_derived,0)) as fees_overdue,\n\nsum(l.penalty_charges_charged_derived) as penalties,\nsum(l.penalty_charges_repaid_derived) as penalties_repaid,\nsum(l.penalty_charges_outstanding_derived) as penalties_outstanding,\nsum(ifnull(laa.penalty_charges_overdue_derived,0)) as penalties_overdue\n\nfrom \n(select l.id as loanId, l.number_of_repayments, min(r.installment), \nounder.id as branchId, ounder.hierarchy, ounder.`name` as branch, \nifnull(cur.display_symbol, l.currency_code) as Currency,\nlo.display_name as \"Loan Officer\", c.id as clientId, c.account_no as \"Client Account No\",\nc.display_name as \"Client\", l.account_no as \"Loan Account No\", pl.`name` as \"Product\", \nf.`name` as Fund,  l.principal_amount as \"Loan Amount\", \nl.annual_nominal_interest_rate as \"Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed\", date(l.expected_maturedon_date) as \"Expected Matured On\"\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_loan_repayment_schedule r on r.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.loan_status_id = 300\nand r.completed_derived is false\nand r.duedate >= curdate()\ngroup by l.id\nhaving l.number_of_repayments = min(r.installment)) lastInstallment\njoin m_loan l on l.id = lastInstallment.loanId\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\ngroup by lastInstallment.branchId) x on x.branchId = mo.id\norder by mo.hierarchy, x.Currency", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 59, "Active Loans by Disbursal Period", "Table", null, "Loan", "select concat(repeat(\"..\",   \n   ((LENGTH(ounder.`hierarchy`) - LENGTH(REPLACE(ounder.`hierarchy`, '.', '')) - 1))), ounder.`name`) as \"Office/Branch\",\nifnull(cur.display_symbol, l.currency_code) as Currency,\nc.account_no as \"Client Account No\", c.display_name as \"Client\", l.account_no as \"Loan Account No\", pl.`name` as \"Product\", \nf.`name` as Fund,  \nl.principal_amount as \"Loan Principal Amount\", \nl.annual_nominal_interest_rate as \" Annual Nominal Interest Rate\", \ndate(l.disbursedon_date) as \"Disbursed Date\", \n\nl.total_expected_repayment_derived as \"Total Loan (P+I+F+Pen)\",\nl.total_repayment_derived as \"Total Repaid (P+I+F+Pen)\",\nlo.display_name as \"Loan Officer\"\n\nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\nand ounder.hierarchy like concat('${currentUserHierarchy}', '%')\njoin m_client c on c.office_id = ounder.id\njoin m_loan l on l.client_id = c.id\njoin m_product_loan pl on pl.id = l.product_id\nleft join m_staff lo on lo.id = l.loan_officer_id\nleft join m_currency cur on cur.code = l.currency_code\nleft join m_fund f on f.id = l.fund_id\nleft join m_loan_arrears_aging laa on laa.loan_id = l.id\nwhere o.id = ${officeId}\nand (l.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\nand (l.product_id = \"${loanProductId}\" or \"-1\" = \"${loanProductId}\")\nand (ifnull(l.loan_officer_id, -10) = \"${loanOfficerId}\" or \"-1\" = \"${loanOfficerId}\")\nand (ifnull(l.fund_id, -10) = ${fundId} or -1 = ${fundId})\nand (ifnull(l.loanpurpose_cv_id, -10) = ${loanPurposeId} or -1 = ${loanPurposeId})\nand l.disbursedon_date between '${startDate}' and '${endDate}'\nand l.loan_status_id = 300\ngroup by l.id\norder by ounder.hierarchy, l.currency_code, c.account_no, l.account_no", "Individual Client \n\nReport", 1, 1);
            insert_stretchy_report(named, stretchy_report, 61, "Aging Summary (Arrears in Months)", "Table", null, "Loan", "SELECT \n  IFNULL(periods.currencyName, periods.currency) as currency, \n  periods.period_no 'Days In Arrears', \n  IFNULL(ars.loanId, 0) 'No Of Loans', \n  IFNULL(ars.principal,0.0) 'Original Principal', \n  IFNULL(ars.interest,0.0) 'Original Interest', \n  IFNULL(ars.prinPaid,0.0) 'Principal Paid', \n  IFNULL(ars.intPaid,0.0) 'Interest Paid', \n  IFNULL(ars.prinOverdue,0.0) 'Principal Overdue', \n  IFNULL(ars.intOverdue,0.0)'Interest Overdue'\nFROM \n\t/* full table of aging periods/currencies used combo to ensure each line represented */\n  (SELECT curs.code as currency, curs.name as currencyName, pers.* from\n\t(SELECT 'On Schedule' period_no,1 pid UNION\n\t\tSELECT '0 - 30',2 UNION\n\t\tSELECT '30 - 60',3 UNION\n\t\tSELECT '60 - 90',4 UNION\n\t\tSELECT '90 - 180',5 UNION\n\t\tSELECT '180 - 360',6 UNION\n\t\tSELECT '> 360',7 ) pers,\n\t(SELECT distinctrow moc.code, moc.name\n  \tFROM m_office mo2\n   \tINNER JOIN m_office ounder2 ON ounder2.hierarchy \n\t\t\t\tLIKE CONCAT(mo2.hierarchy, '%')\nAND ounder2.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n   \tINNER JOIN m_client mc2 ON mc2.office_id=ounder2.id\n   \tINNER JOIN m_loan ml2 ON ml2.client_id = mc2.id\n\tINNER JOIN m_organisation_currency moc ON moc.code = ml2.currency_code\n\tWHERE ml2.loan_status_id=300 /* active */\n\tAND mo2.id=${officeId}\nAND (ml2.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")) curs) periods\n\n\nLEFT JOIN /* table of aging periods per currency with gaps if no applicable loans */\n(SELECT \n  \tz.currency, z.arrPeriod, \n\tCOUNT(z.loanId) as loanId, SUM(z.principal) as principal, SUM(z.interest) as interest, \n\tSUM(z.prinPaid) as prinPaid, SUM(z.intPaid) as intPaid, \n\tSUM(z.prinOverdue) as prinOverdue, SUM(z.intOverdue) as intOverdue\nFROM\n\t/*derived table just used to get arrPeriod value (was much slower to\n\tduplicate calc of minOverdueDate in inner query)\nmight not be now with derived fields but didn’t check */\n\t(SELECT x.loanId, x.currency, x.principal, x.interest, x.prinPaid, x.intPaid, x.prinOverdue, x.intOverdue,\n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<1, 'On Schedule', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<31, '0 - 30', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<61, '30 - 60', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<91, '60 - 90', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<181, '90 - 180', \n\t\tIF(DATEDIFF(CURDATE(), minOverdueDate)<361, '180 - 360', \n\t\t\t\t '> 360')))))) AS arrPeriod\n\n\tFROM /* get the individual loan details */\n\t\t(SELECT ml.id AS loanId, ml.currency_code as currency,\n   \t\t\tml.principal_disbursed_derived as principal, \n\t\t\t   ml.interest_charged_derived as interest, \n   \t\t\tml.principal_repaid_derived as prinPaid, \n\t\t\t   ml.interest_repaid_derived intPaid,\n\n\t\t\t   laa.principal_overdue_derived as prinOverdue,\n\t\t\t   laa.interest_overdue_derived as intOverdue,\n\n\t\t\t   IFNULL(laa.overdue_since_date_derived, curdate()) as minOverdueDate\n\t\t\t  \n  \t\tFROM m_office mo\n   \t\tINNER JOIN m_office ounder ON ounder.hierarchy \n\t\t\t\tLIKE CONCAT(mo.hierarchy, '%')\nAND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n   \t\tINNER JOIN m_client mc ON mc.office_id=ounder.id\n   \t\tINNER JOIN m_loan ml ON ml.client_id = mc.id\n\t\t   LEFT JOIN m_loan_arrears_aging laa on laa.loan_id = ml.id\n\t\tWHERE ml.loan_status_id=300 /* active */\n     \t\tAND mo.id=${officeId}\n     AND (ml.currency_code = \"${currencyId}\" or \"-1\" = \"${currencyId}\")\n  \t\tGROUP BY ml.id) x\n\t) z \nGROUP BY z.currency, z.arrPeriod ) ars ON ars.arrPeriod=periods.period_no and ars.currency = periods.currency\nORDER BY periods.currency, periods.pid", "Loan amount in arrears by branch", 1, 1);
            insert_stretchy_report(named, stretchy_report, 91, "Loan Account Schedule", "Pentaho", null, "Loan", null, null, 1, 0);
            insert_stretchy_report(named, stretchy_report, 92, "Branch Expected Cash Flow", "Pentaho", null, "Loan", null, null, 1, 1);
            insert_stretchy_report(named, stretchy_report, 93, "Expected Payments By Date - Basic", "Table", null, "Loan", "SELECT \n      ounder.name 'Office', \n      IFNULL(ms.display_name,'-') 'Loan Officer',\n\t  mc.account_no 'Client Account Number',\n\t  mc.display_name 'Name',\n\t  mp.name 'Product',\n\t  ml.account_no 'Loan Account Number',\n\t  mr.duedate 'Due Date',\n\t  mr.installment 'Installment',\n\t  cu.display_symbol 'Currency',\n\t  mr.principal_amount- IFNULL(mr.principal_completed_derived,0) 'Principal Due',\n\t  mr.interest_amount- IFNULL(IFNULL(mr.interest_completed_derived,mr.interest_waived_derived),0) 'Interest Due', \n\t  IFNULL(mr.fee_charges_amount,0)- IFNULL(IFNULL(mr.fee_charges_completed_derived,mr.fee_charges_waived_derived),0) 'Fees Due', \n\t  IFNULL(mr.penalty_charges_amount,0)- IFNULL(IFNULL(mr.penalty_charges_completed_derived,mr.penalty_charges_waived_derived),0) 'Penalty Due',\n      (mr.principal_amount- IFNULL(mr.principal_completed_derived,0)) +\n       (mr.interest_amount- IFNULL(IFNULL(mr.interest_completed_derived,mr.interest_waived_derived),0)) + \n       (IFNULL(mr.fee_charges_amount,0)- IFNULL(IFNULL(mr.fee_charges_completed_derived,mr.fee_charges_waived_derived),0)) + \n       (IFNULL(mr.penalty_charges_amount,0)- IFNULL(IFNULL(mr.penalty_charges_completed_derived,mr.penalty_charges_waived_derived),0)) 'Total Due', \n     mlaa.total_overdue_derived 'Total Overdue'\n\t\t\t\t\t\t\t\t\t\t \n FROM m_office mo\n  JOIN m_office ounder ON ounder.hierarchy LIKE CONCAT(mo.hierarchy, '%')\n  \n  AND ounder.hierarchy like CONCAT('${currentUserHierarchy}', '%')\n\t\n  LEFT JOIN m_client mc ON mc.office_id=ounder.id\n  LEFT JOIN m_loan ml ON ml.client_id=mc.id AND ml.loan_status_id=300\n  LEFT JOIN m_loan_arrears_aging mlaa ON mlaa.loan_id=ml.id\n  LEFT JOIN m_loan_repayment_schedule mr ON mr.loan_id=ml.id AND mr.completed_derived=0\n  LEFT JOIN m_product_loan mp ON mp.id=ml.product_id\n  LEFT JOIN m_staff ms ON ms.id=ml.loan_officer_id\n  LEFT JOIN m_currency cu ON cu.code=ml.currency_code\n WHERE mo.id=${officeId}\n AND (IFNULL(ml.loan_officer_id, -10) = \"${loanOfficerId}\" OR \"-1\" = \"${loanOfficerId}\")\n AND mr.duedate BETWEEN '${startDate}' AND '${endDate}'\n ORDER BY ounder.id,mr.duedate,ml.account_no", "Test", 1, 1);
            insert_stretchy_report(named, stretchy_report, 94, "Expected Payments By Date - Formatted", "Pentaho", null, "Loan", null, null, 1, 1);
        }
        {
            dataContext.refreshSchemas();
            Table stretchy_parameter = dataContext.getDefaultSchema().getTableByName("stretchy_parameter");
            insert_stretchy_parameter(named, stretchy_parameter, 1, "startDateSelect", "startDate", "startDate", "date", "date", "today", null, null, null, null, null);
            insert_stretchy_parameter(named, stretchy_parameter, 2, "endDateSelect", "endDate", "endDate", "date", "date", "today", null, null, null, null, null);
            insert_stretchy_parameter(named, stretchy_parameter, 3, "obligDateTypeSelect", "obligDateType", "obligDateType", "select", "number", "0", null, null, null, "select * from\n(select 1 as id, \"Closed\" as `name` union all\nselect 2, \"Disbursal\" ) x\norder by x.`id`", null);
            insert_stretchy_parameter(named, stretchy_parameter, 5, "OfficeIdSelectOne", "officeId", "Office", "select", "number", "0", null, "Y", null, "select id, \nconcat(substring(\"........................................\", 1, \n   \n\n((LENGTH(`hierarchy`) - LENGTH(REPLACE(`hierarchy`, '.', '')) - 1) * 4)), \n   `name`) as tc\nfrom m_office\nwhere hierarchy like concat\n\n('${currentUserHierarchy}', '%')\norder by hierarchy", null);
            insert_stretchy_parameter(named, stretchy_parameter, 6, "loanOfficerIdSelectAll", "loanOfficerId", "Loan Officer", "select", "number", "0", null, null, "Y", "(select lo.id, lo.display_name as `Name` \nfrom m_office o \njoin m_office ounder on ounder.hierarchy like concat(o.hierarchy, '%')\njoin m_staff lo on lo.office_id = ounder.id\nwhere lo.is_loan_officer = true\nand o.id = ${officeId})\nunion all\n(select -10, '-')\norder by 2", "5");
            insert_stretchy_parameter(named, stretchy_parameter, 10, "currencyIdSelectAll", "currencyId", "Currency", "select", "number", "0", null, null, "Y", "select `code`, `name`\nfrom m_organisation_currency\norder by `code`", null);
            insert_stretchy_parameter(named, stretchy_parameter, 20, "fundIdSelectAll", "fundId", "Fund", "select", "number", "0", null, null, "Y", "(select id, `name`\nfrom m_fund)\nunion all\n(select -10, '-')\norder by 2", null);
            insert_stretchy_parameter(named, stretchy_parameter, 25, "loanProductIdSelectAll", "loanProductId", "Product", "select", "number", "0", null, null, "Y", "select p.id, p.`name`\nfrom m_product_loan p\nwhere p.currency_code = '${currencyId}'\norder by 2", "10");
            insert_stretchy_parameter(named, stretchy_parameter, 26, "loanPurposeIdSelectAll", "loanPurposeId", "Loan Purpose", "select", "number", "0", null, null, "Y", "select -10 as id, '-' as code_value\nunion all\nselect * from (select v.id, v.code_value\nfrom m_code c\njoin m_code_value v on v.code_id = c.id\nwhere c.code_name = \"loanPurpose\"\norder by v.order_position)  x", null);
            insert_stretchy_parameter(named, stretchy_parameter, 100, "parTypeSelect", "parType", "parType", "select", "number", "0", null, null, null, "select * from\n(select 1 as id, \"Principal Only\" as `name` union all\nselect 2, \"Principal + Interest\" union all\nselect 3, \"Principal + Interest + Fees\" union all\nselect 4, \"Principal + Interest + Fees + Penalties\") x\norder by x.`id`", null);
            insert_stretchy_parameter(named, stretchy_parameter, 1001, "FullReportList", null, "n/a", "n/a", "n/a", "n/a", "Y", null, null, "select  r.report_id, r.report_name, r.report_type, r.report_subtype, r.report_category,\n  \n\nrp.parameter_id, rp.report_parameter_name, p.parameter_name\n  from stretchy_report r\n  left join stretchy_report_parameter rp on rp.report_id = r.report_id\n  \n\nleft join stretchy_parameter p on p.parameter_id = rp.parameter_id\n  where r.use_report is true\n  and exists\n  (\n select 'f'\n  from m_appuser_role ur \n\n\n  join m_role r on r.id = ur.role_id\n  join m_role_permission rp on rp.role_id = r.id\n  join m_permission p on p.id = rp.permission_id\n  where \n\nur.appuser_id = ${currentUserId}\n  and (p.code in ('ALL_FUNCTIONS_READ', 'ALL_FUNCTIONS') or p.code = concat(\"READ_\", r.report_name))\n )\n  order by \n\nr.report_category, r.report_name, rp.parameter_id", null);
            insert_stretchy_parameter(named, stretchy_parameter, 1002, "FullParameterList", null, "n/a", "n/a", "n/a", "n/a", "Y", null, null, "select sp.parameter_name, sp.parameter_variable, sp.parameter_label, sp.parameter_displayType, \nsp.parameter_FormatType, sp.parameter_default, sp.selectOne,  sp.selectAll, spp.parameter_name as parentParameterName\nfrom stretchy_parameter sp\nleft join stretchy_parameter spp on spp.parameter_id = sp.parent_parameter_id\nwhere sp.special is null\nand exists \n\t(select 'f' \n\tfrom stretchy_report sr\n\tjoin stretchy_report_parameter srp on srp.report_id = sr.report_id\n\twhere sr.report_name in(${reportListing})\n\tand srp.parameter_id = sp.parameter_id\n\t)\norder by sp.parameter_id", null);
            insert_stretchy_parameter(named, stretchy_parameter, 1003, "reportCategoryList", null, "n/a", "n/a", "n/a", "n/a", "Y", null, null, "select  r.report_id, r.report_name, r.report_type, r.report_subtype, \n\nr.report_category,\n  rp.parameter_id, rp.report_parameter_name, p.parameter_name\n  from stretchy_report r\n  left join stretchy_report_parameter rp on \n\nrp.report_id = r.report_id\n  left join stretchy_parameter p on p.parameter_id = rp.parameter_id\n  where r.report_category = '${reportCategory}'\n  and \n\nr.use_report is true\n  and exists\n  (\n select 'f'\n  from m_appuser_role ur \n  join m_role r on r.id = ur.role_id\n  join m_role_permission rp on \n\nrp.role_id = r.id\n  join m_permission p on p.id = rp.permission_id\n  where ur.appuser_id = ${currentUserId}\n  and (p.code in ('ALL_FUNCTIONS_READ', \n\n'ALL_FUNCTIONS') or p.code = concat(\"READ_\", r.report_name))\n )\n  order by r.report_category, r.report_name, rp.parameter_id", null);
        }
        {
            Table stretchy_report_parameter = dataContext.getDefaultSchema().getTableByName("stretchy_report_parameter");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 1, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 2, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 5, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 6, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 7, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 8, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 8, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 8, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 8, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 8, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 11, 100, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 12, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 3, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 13, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 3, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 14, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 15, 100, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 16, 100, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 20, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 20, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 20, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 20, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 21, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 21, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 21, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 21, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 21, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 48, 5, "branch");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 48, 2, "date");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 49, 5, "branch");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 49, 1, "fromDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 49, 2, "toDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 50, 5, "branch");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 50, 1, "fromDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 50, 2, "toDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 51, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 51, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 51, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 51, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 51, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 52, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 53, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 53, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 54, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 54, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 54, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 54, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 54, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 55, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 56, 100, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 57, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 58, 100, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 20, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 25, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 59, 26, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 61, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 61, 10, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 92, 1, "fromDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 92, 5, "selectOffice");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 92, 2, "toDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 93, 1, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 93, 2, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 93, 5, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 93, 6, null);
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 94, 2, "endDate");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 94, 6, "loanOfficerId");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 94, 5, "officeId");
            insert_stretchy_report_parameter(named, stretchy_report_parameter, 94, 1, "startDate");
        }
        {
            dataContext.refreshSchemas();
            Table stretchy_report = dataContext.getDefaultSchema().getTableByName("stretchy_report");
            Table m_permission = dataContext.getDefaultSchema().getTableByName("m_permission");
            SelectQuery selectQuery = new SelectQuery(stretchy_report.getName());
            for (Map<String, Object> record : named.queryForList(selectQuery.toSQL(), selectQuery.toParam())) {
                insert_m_permission(named, m_permission, "report", "READ_" + record.get(stretchy_report.getColumnByName("report_name").getName()), (String) record.get(stretchy_report.getColumnByName("report_name").getName()), "READ", 1);
            }
        }
    }

    protected void insert_stretchy_parameter(NamedParameterJdbcTemplate named, Table table, long parameter_id, String parameter_name, String parameter_variable, String parameter_label, String parameter_displayType, String parameter_FormatType, String parameter_default, String special, String selectOne, String selectAll, String parameter_sql, String parent_parameter_id) {
        InsertQuery insertQuery = new InsertQuery(table.getName());
        insertQuery.addValue(table.getColumnByName("parameter_id").getName(), parameter_id);
        insertQuery.addValue(table.getColumnByName("parameter_name").getName(), parameter_name);
        insertQuery.addValue(table.getColumnByName("parameter_variable").getName(), parameter_variable);
        insertQuery.addValue(table.getColumnByName("parameter_label").getName(), parameter_label);
        insertQuery.addValue(table.getColumnByName("parameter_displayType").getName(), parameter_displayType);
        insertQuery.addValue(table.getColumnByName("parameter_FormatType").getName(), parameter_FormatType);
        insertQuery.addValue(table.getColumnByName("parameter_default").getName(), parameter_default);
        insertQuery.addValue(table.getColumnByName("special").getName(), special);
        insertQuery.addValue(table.getColumnByName("selectOne").getName(), selectOne);
        insertQuery.addValue(table.getColumnByName("selectAll").getName(), selectAll);
        insertQuery.addValue(table.getColumnByName("parameter_sql").getName(), parameter_sql);
        insertQuery.addValue(table.getColumnByName("parent_parameter_id").getName(), parent_parameter_id);
        named.update(insertQuery.toSQL(), insertQuery.toParam());
    }

    protected void insert_m_permission(NamedParameterJdbcTemplate named, Table table, String grouping, String code, String entity_name, String action_name, long can_maker_checker) {
        InsertQuery insertQuery = new InsertQuery(table.getName());
        insertQuery.addValue(table.getColumnByName("grouping").getQualifiedLabel(), grouping);
        insertQuery.addValue(table.getColumnByName("code").getName(), code);
        insertQuery.addValue(table.getColumnByName("entity_name").getName(), entity_name);
        insertQuery.addValue(table.getColumnByName("action_name").getName(), action_name);
        insertQuery.addValue(table.getColumnByName("can_maker_checker").getName(), can_maker_checker);
        named.update(insertQuery.toSQL(), insertQuery.toParam());
    }

    protected void insert_stretchy_report(NamedParameterJdbcTemplate named, Table table, long report_id, String report_name, String report_type, String report_subtype, String report_category, String report_sql, String description, long core_report, long use_report) {
        InsertQuery insertQuery = new InsertQuery(table.getName());
        insertQuery.addValue(table.getColumnByName("report_id").getName(), report_id);
        insertQuery.addValue(table.getColumnByName("report_name").getName(), report_name);
        insertQuery.addValue(table.getColumnByName("report_type").getName(), report_type);
        insertQuery.addValue(table.getColumnByName("report_subtype").getName(), report_subtype);
        insertQuery.addValue(table.getColumnByName("report_category").getName(), report_category);
        insertQuery.addValue(table.getColumnByName("report_sql").getName(), report_sql);
        insertQuery.addValue(table.getColumnByName("description").getName(), description);
        insertQuery.addValue(table.getColumnByName("core_report").getName(), core_report);
        insertQuery.addValue(table.getColumnByName("use_report").getName(), use_report);
        named.update(insertQuery.toSQL(), insertQuery.toParam());
    }

    protected void insert_stretchy_report_parameter(NamedParameterJdbcTemplate named, Table table, long report_id, long parameter_id, String report_parameter_name) {
        InsertQuery insertQuery = new InsertQuery(table.getName());
        insertQuery.addValue(table.getColumnByName("report_id").getName(), report_id);
        insertQuery.addValue(table.getColumnByName("parameter_id").getName(), parameter_id);
        insertQuery.addValue(table.getColumnByName("report_parameter_name").getName(), report_parameter_name);
        named.update(insertQuery.toSQL(), insertQuery.toParam());
    }

}